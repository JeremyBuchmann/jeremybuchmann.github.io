<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <title>Jeremy Buchmann</title>
    <meta name="author" content="Jeremy Buchmann">


    <link rel="stylesheet" href="http://jeremybuchmann.com/theme/css/main.css" type="text/css" />



    <link href="http://jeremybuchmann.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Jeremy Buchmann Atom Feed" />
</head>

<body>

    <div class="container">

      <header>
        <div class="feeds">
          <a href="http://jeremybuchmann.com/feeds/all.atom.xml" rel="alternate"><img src="http://jeremybuchmann.com/theme/images/icons/feed-32px.png" alt="atom feed"/></a>
        </div>
          <nav class="pages">
              <a href="http://jeremybuchmann.com/pages/about-me.html">About&nbsp;Me</a>
-              <a href="http://jeremybuchmann.com/pages/curriculum-vitae.html">Curriculum&nbsp;Vitae</a>
          </nav>
    <a href="http://jeremybuchmann.com" class="title">Jeremy Buchmann</a>
      </header>

      <div class="wrapper">

      <div role="main" class="content">




        <article>
          <h1><a href="http://jeremybuchmann.com/how-to-get-php-to-authenticate-with-ad-using-ldaps.html">How to get <span class="caps">PHP</span> to authenticate with <span class="caps">AD</span> using <span class="caps">LDAPS</span></a></h1>
          <p>If you use Active Directory for authentication and also want to
authenticate to it from <span class="caps">PHP</span> code, there are a few hoops to jump through,
especially if you want to use <span class="caps">LDAPS</span> (<span class="caps">LDAP</span> over <span class="caps">SSL</span>/<span class="caps">TLS</span>). The clients
accomplish this from <span class="caps">PHP</span> using the php-ldap library which uses the
OpenLDAP library which in turn uses the OpenSSL library. I bring this up
because you’ll have to read some documentation from both OpenLDAP and
OpenSSL to understand what’s going&nbsp;on.</p>
<p>When a client program tries to bind to the <span class="caps">AD</span> server, OpenSSL will try
to verify the server’s <span class="caps">SSL</span> certificate. <span class="caps">SSL</span> certificates are issued by a
Certificate Authority (<span class="caps">CA</span>) which have their own certificates to verify
their identities. However, if you have self-signed the certificate for
your <span class="caps">AD</span> server, the <span class="caps">CA</span> cert is essentially phony. This prevents OpenSSL
from verifying the connection which prevents OpenLDAP from connecting to
the <span class="caps">AD</span>&nbsp;server.</p>
<p>There are two ways around&nbsp;this.</p>
<p>One way is to tell OpenLDAP to not perform a check on the server’s
certificate. To do this, you <em>could</em> add this directive to
<code>/etc/openldap/ldap.conf</code>:</p>
<div class="highlight"><pre><span></span>TLS_REQCERT never # Don’t actually do this!
</pre></div>


<p>But as the <a href="http://www.openldap.org/doc/admin24/tls.html#Client%20Configuration">OpenLDAP manual
states</a>,
“for clients the default value is <code>demand</code> and there generally is no
good reason to change this setting”. So let’s not do&nbsp;that.</p>
<p>Instead, we can provide the client with a copy of the server’s <span class="caps">CA</span>
certificate. Normally, this would come from Verisign or Thawte or
whoever you’d buy a server cert from, but since we’ve self-signed a cert
for the server, we’ve also created a cert for the <span class="caps">CA</span>&#8230;which is&nbsp;us.</p>
<p>By providing this <span class="caps">CA</span> cert to the client, the client will believe that
the self-signed certificate is valid, which is what we&nbsp;want.</p>
<p>The <span class="caps">CA</span> cert is a <span class="caps">PEM</span> file. Depending on your Linux distribution, the <span class="caps">CA</span>
cert file will go into <code>/etc/ssl/certs</code> (Ubuntu),
<code>/etc/openldap/cacerts</code> (Red Hat/CentOS 6), or <code>/etc/openldap/certs</code>
(Red Hat/CentOS 7). The permissions on the <span class="caps">PEM</span> files must be be
world-readable (644), or you must create a special group, add the owner
of the process that is accessing the cert to the group, and set the
permission of the cert file to group-readable&nbsp;(640).</p>
<p>There’s one more step. For whatever reason, OpenSSL expects these files
to be named in the form of <span class="caps">HHHHHHHH</span>.D, where each H is a hexadecimal
character and D is a single decimal digit. There’s a script in the
openssl-perl package called <code>c_rehash</code> that creates symlinks in the
right format for you. For&nbsp;example:</p>
<div class="highlight"><pre><span></span>[root@host]# c_rehash /etc/openldap/certs
Doing /etc/openldap/certs
host-ca.pem =&gt; 4d86282a.0
</pre></div>


<p>Once you have the <span class="caps">PEM</span> files and the symlinks in the right place, the <span class="caps">AD</span>
authentication in your <span class="caps">PHP</span> script should&nbsp;work.</p>
<p>Note: the c_rehash script is really&nbsp;doing:</p>
<div class="highlight"><pre><span></span>[root@host]# openssl x509 -hash -fingerprint -noout -in file.pem
</pre></div>


<p>and taking the first line of output to create the hash file&nbsp;name.</p>
        </article>

        <hr />

          <div>
            <h3>Last posts</h3>
            <ol class="archive">



        <li>
<a href="http://jeremybuchmann.com/hack4reno-recap.html" rel="bookmark" title="Permalink to Hack4Reno Recap">Hack4Reno&nbsp;Recap</a>
  <time datetime="2015-11-09T13:02:00+01:00">Nov 09, 2015</time>
        </li>


        <li>
<a href="http://jeremybuchmann.com/five-tools-every-programmer-should-have-that-arent-on-a-computer.html" rel="bookmark" title="Permalink to Five Tools Every Programmer Should Have (that aren’t on a computer)">Five Tools Every Programmer Should Have (that aren&#8217;t on a&nbsp;computer)</a>
  <time datetime="2012-06-20T15:35:00+02:00">Jun 20, 2012</time>
        </li>


        <li>
<a href="http://jeremybuchmann.com/creating-good-sql-aliases.html" rel="bookmark" title="Permalink to Creating Good SQL Aliases">Creating Good <span class="caps">SQL</span>&nbsp;Aliases</a>
  <time datetime="2012-06-16T21:15:00+02:00">Jun 16, 2012</time>
        </li>


            </ol>
          </div>


      </div>

      <div class="sidebar">
        <div class="sidebar-container" >

                <aside>
                  <h2>About</h2>
          <p>
                    This is the website of Jeremy Buchmann, a Web developer in Eindhoven, Netherlands.
          </p>
        </aside>

  	          <nav>
                <h2>Categories</h2>
                <ul>
                    <li ><a href="http://jeremybuchmann.com/category/development.html">development</a></li>
                    <li ><a href="http://jeremybuchmann.com/category/misc.html">misc</a></li>
                </ul>
              </nav>

                <aside>
                <h2>Social</h2>
          <ul class="social">
        <li><a href="https://twitter.com/jeremybuchmann">Twitter</a><i></i></li>
        <li><a href="https://www.linkedin.com/in/jeremybuchmann">LinkedIn</a><i></i></li>
        <li><a href="https://github.com/JeremyBuchmann">Github</a><i></i></li>
          </ul>
        </aside>

                <aside>
                  <h2>Foundation</h2>
                  <ul>
                      <li><a href="https://www.eindhoven.nl/">Live</a></li>
                      <li><a href="https://laurawetherington.com">Love</a></li>
                      <li><a href="https://www.coosto.com">Work</a></li>
                  </ul>
                </aside>
            </div>
      </div>

      </div>

      <footer>
    <p role="contentinfo">
      Jeremy Buchmann - Proudly powered by <a href="http://alexis.notmyidea.org/pelican/">pelican</a>. Theme <a href="https://github.com/fle/pelican-sober">pelican-sober</a>.
    	</p>

      </footer>

    </div>
</body>
</html>