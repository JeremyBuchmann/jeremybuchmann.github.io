<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <title>Efficiently Chunking Files in PHP - Jeremy Buchmann</title>
    <meta name="author" content="Jeremy Buchmann">


  <meta name="description" content="// https://www.sitepoint.com/performant-reading-big-files-php/ // 2017-06-07 11:33:00 / * Utility class for copying files or parts of files in chunks. */ class FileChunker { / * Copies $size bytes of data from $source_fh to $target_fh beginning at * $start. Uses readFileChunk() to do the chunked reads from $source_fh. * * @param resource $source_fh The source file handle …">

	<meta name="twitter:card" content="summary">
	  <meta name="twitter:creator" content="@jeremybuchmann">
	<meta name="twitter:title" content="Efficiently Chunking Files in PHP">
	<meta name="twitter:description" content="// https://www.sitepoint.com/performant-reading-big-files-php/ // 2017-06-07 11:33:00 / * Utility class for copying files or parts of files in chunks. */ class FileChunker { / * Copies $size bytes of data from $source_fh to $target_fh beginning at * $start. Uses readFileChunk() to do the chunked reads from $source_fh. * * @param resource $source_fh The source file handle …">
	<meta name="twitter:url" content="../drafts/efficiently-chunking-files-in-php.html">


    <link rel="stylesheet" href="../theme/css/main.css" type="text/css" />



</head>

<body>

    <div class="container">

      <header>
        <div class="feeds">
        </div>
          <nav class="pages">
              <a href="../pages/about-me.html">About Me</a>
-              <a href="../pages/curriculum-vitae.html">Curriculum Vitae</a>
          </nav>
    <a href=".." class="title">Jeremy Buchmann</a>
      </header>

      <div class="wrapper">

      <div role="main" class="content">
	<article class="full">
		
		<h1>Efficiently Chunking Files in PHP</h1>
		
<div class="metadata">
  <time datetime="2017-06-07T11:33:00+02:00">Jun 07, 2017</time>
    <address class="vcard author">
      by <a class="url fn" href="../author/jeremy-buchmann.html">Jeremy Buchmann</a>
    </address>
  in <a href="../category/development.html">development</a>
</div>		
		<p>// https://www.sitepoint.com/performant-reading-big-files-php/
// 2017-06-07 11:33:00</p>
<p>/<strong>
 * Utility class for copying files or parts of files in chunks.
 */
class FileChunker
{
  /</strong>
   * Copies $size bytes of data from $source_fh to $target_fh beginning at
   * $start. Uses readFileChunk() to do the chunked reads from $source_fh.
   *
   * @param resource $source_fh The source file handle
   * @param resource $target_fh The target file handle
   * @param number $start The start offset location in the source file
   * @param number $size The number of bytes to copy
   * @throws Exception When either the source or target file handles are
   * invalid
   * @return number|boolean The number of bytes copied, or false if
   * something completely nuts happened
   */
  public static function copyChunk($source_fh, $target_fh, $start, $size)
  {
    // This size was determined empirically, albeit on a laptop
    $chunk_size = 1024 * 1024 * 0.25;</p>
<div class="highlight"><pre><span></span><code><span class="k">if</span> <span class="p">(</span><span class="n">is_resource</span><span class="p">(</span><span class="err">$</span><span class="n">source_fh</span><span class="p">))</span> <span class="err">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">is_resource</span><span class="p">(</span><span class="err">$</span><span class="n">target_fh</span><span class="p">))</span> <span class="err">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="err">$</span><span class="k">start</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="err">$</span><span class="k">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="err">{</span>
      <span class="err">$</span><span class="n">num_bytes_written</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="n">foreach</span> <span class="p">(</span><span class="k">self</span><span class="p">::</span><span class="n">readFileChunk</span><span class="p">(</span><span class="err">$</span><span class="n">source_fh</span><span class="p">,</span> <span class="err">$</span><span class="k">start</span><span class="p">,</span> <span class="err">$</span><span class="k">size</span><span class="p">,</span> <span class="err">$</span><span class="n">chunk_size</span><span class="p">)</span> <span class="k">as</span> <span class="err">$</span><span class="n">chunk</span><span class="p">)</span> <span class="err">{</span>
        <span class="err">$</span><span class="n">num_bytes_written</span> <span class="o">+=</span> <span class="n">fwrite</span><span class="p">(</span><span class="err">$</span><span class="n">target_fh</span><span class="p">,</span> <span class="err">$</span><span class="n">chunk</span><span class="p">);</span>
      <span class="err">}</span>

      <span class="k">return</span> <span class="err">$</span><span class="n">num_bytes_written</span><span class="p">;</span>
    <span class="err">}</span> <span class="k">else</span> <span class="err">{</span>
      <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="err">}</span>
  <span class="err">}</span> <span class="k">else</span> <span class="err">{</span>
    <span class="n">throw</span> <span class="k">new</span> <span class="k">Exception</span><span class="p">(</span><span class="s1">&#39;target filehandle is not a valid resource&#39;</span><span class="p">);</span>
  <span class="err">}</span>
<span class="err">}</span> <span class="k">else</span> <span class="err">{</span>
  <span class="n">throw</span> <span class="k">new</span> <span class="k">Exception</span><span class="p">(</span><span class="s1">&#39;source filehandle is not a valid resource&#39;</span><span class="p">);</span>
<span class="err">}</span>

<span class="k">return</span> <span class="k">false</span><span class="p">;</span>
</code></pre></div>


<p>}</p>
<p>/*<em>
   * Generator function that reads data from the given file in
   * $chunk_size pieces, beginning at $start and ending after
   * $total_size bytes have been read.
   *
   * This function will check whether it can read $total_size bytes from
   * $fh, and if it can't, it will reset $total_size to whatever it can read.
   *
   * @param resource $fh
   * @param number $start The start offset location in the file
   * @param number $total_size The total amount of data to read from the file
   * @param number $chunk_size The size of the chunks to read
   * @throws Exception When the file handle is invalid
   * @return Generator
   </em>/
  public static function readFileChunk($fh, $start, $total_size, $chunk_size)
  {
    if (is_resource($fh)) {
      // Check whether it's possible to read $total_size bytes from $fh
      // given the start position. Reset $total_size if it's not possible.
      $stat = fstat($fh);
      if (($stat['size'] - $start) &lt; $total_size) {
        $total_size = $stat['size'] - $start;
      }</p>
<div class="highlight"><pre><span></span><code><span class="err">  fseek($fh, $start);</span>
<span class="err">  $size_cnt = 0;</span>
<span class="err">  while ($size_cnt &lt; $total_size) {</span>
<span class="err">    $data = fread($fh, min($chunk_size, $total_size));</span>
<span class="err">    $size_cnt += strlen($data);</span>
<span class="err">    yield $data;</span>
<span class="err">  }</span>
<span class="err">} else {</span>
<span class="err">  throw new Exception(&#39;filehandle is not a valid resource&#39;);</span>
<span class="err">}</span>
</code></pre></div>


<p>}
}</p>	

	</article>



      </div>

      <div class="sidebar">
        <div class="sidebar-container" >

                <aside>
                  <h2>About</h2>
          <p>
                    This is the website of Jeremy Buchmann, a Web developer in Eindhoven, Netherlands.
          </p>
        </aside>

  	          <nav>
                <h2>Categories</h2>
                <ul>
                    <li ><a href="../category/beer.html">beer</a></li>
                    <li class="active"><a href="../category/development.html">development</a></li>
                    <li ><a href="../category/misc.html">misc</a></li>
                </ul>
              </nav>

                <aside>
                <h2>Social</h2>
          <ul class="social">
        <li><a href="https://twitter.com/jeremybuchmann">Twitter</a><i></i></li>
        <li><a href="https://www.linkedin.com/in/jeremybuchmann">LinkedIn</a><i></i></li>
        <li><a href="https://github.com/JeremyBuchmann">Github</a><i></i></li>
          </ul>
        </aside>

                <aside>
                  <h2>Foundation</h2>
                  <ul>
                      <li><a href="https://www.eindhoven.nl/">Live</a></li>
                      <li><a href="https://laurawetherington.com">Love</a></li>
                      <li><a href="https://www.coosto.com">Work</a></li>
                  </ul>
                </aside>
            </div>
      </div>

      </div>

      <footer>
    <p role="contentinfo">
      Copyright &copy; Jeremy Buchmann 2012-2018
    </p>

      </footer>

    </div>
</body>
</html>