<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <title>How to get PHP to authenticate with AD using LDAPS - Jeremy Buchmann</title>
    <meta name="author" content="Jeremy Buchmann">


  <meta name="description" content="If you use Active Directory for authentication and also want to authenticate to it from PHP code, there are a few hoops to jump through, especially if you want to use LDAPS (LDAP over SSL/TLS). The clients accomplish this from PHP using the php-ldap library which uses the OpenLDAP …">

	<meta name="twitter:card" content="summary">
	  <meta name="twitter:creator" content="@jeremybuchmann">
	<meta name="twitter:title" content="How to get PHP to authenticate with AD using LDAPS">
	<meta name="twitter:description" content="If you use Active Directory for authentication and also want to authenticate to it from PHP code, there are a few hoops to jump through, especially if you want to use LDAPS (LDAP over SSL/TLS). The clients accomplish this from PHP using the php-ldap library which uses the OpenLDAP …">
	<meta name="twitter:url" content="http://jeremybuchmann.com/how-to-get-php-to-authenticate-with-ad-using-ldaps.html">


    <link rel="stylesheet" href="http://jeremybuchmann.com/theme/css/main.css" type="text/css" />



    <link href="http://jeremybuchmann.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Jeremy Buchmann Atom Feed" />
</head>

<body>

    <div class="container">

      <header>
        <div class="feeds">
          <a href="http://jeremybuchmann.com/feeds/all.atom.xml" rel="alternate"><img src="http://jeremybuchmann.com/theme/images/icons/feed-32px.png" alt="atom feed"/></a>
        </div>
          <nav class="pages">
              <a href="http://jeremybuchmann.com/pages/about-me.html">About Me</a>
-              <a href="http://jeremybuchmann.com/pages/curriculum-vitae.html">Curriculum Vitae</a>
          </nav>
    <a href="http://jeremybuchmann.com" class="title">Jeremy Buchmann</a>
      </header>

      <div class="wrapper">

      <div role="main" class="content">
	<article class="full">
		
		<h1>How to get PHP to authenticate with AD using LDAPS</h1>
		
<div class="metadata">
  <time datetime="2016-03-16T21:43:00+01:00">Mar 16, 2016</time>
    <address class="vcard author">
      by <a class="url fn" href="http://jeremybuchmann.com/author/jeremy-buchmann.html">Jeremy Buchmann</a>
    </address>
  in <a href="http://jeremybuchmann.com/category/development.html">development</a>
</div>		
		<p>If you use Active Directory for authentication and also want to
authenticate to it from PHP code, there are a few hoops to jump through,
especially if you want to use LDAPS (LDAP over SSL/TLS). The clients
accomplish this from PHP using the php-ldap library which uses the
OpenLDAP library which in turn uses the OpenSSL library. I bring this up
because you’ll have to read some documentation from both OpenLDAP and
OpenSSL to understand what’s going on.</p>
<p>When a client program tries to bind to the AD server, OpenSSL will try
to verify the server’s SSL certificate. SSL certificates are issued by a
Certificate Authority (CA) which have their own certificates to verify
their identities. However, if you have self-signed the certificate for
your AD server, the CA cert is essentially phony. This prevents OpenSSL
from verifying the connection which prevents OpenLDAP from connecting to
the AD server.</p>
<p>There are two ways around this.</p>
<p>One way is to tell OpenLDAP to not perform a check on the server’s
certificate. To do this, you <em>could</em> add this directive to
<code>/etc/openldap/ldap.conf</code>:</p>
<div class="highlight"><pre><span></span><span class="nv">TLS_REQCERT</span> <span class="nv">never</span> # <span class="nv">Don</span>’<span class="nv">t</span> <span class="nv">actually</span> <span class="k">do</span> <span class="nv">this</span><span class="o">!</span>
</pre></div>


<p>But as the <a href="http://www.openldap.org/doc/admin24/tls.html#Client%20Configuration">OpenLDAP manual
states</a>,
“for clients the default value is <code>demand</code> and there generally is no
good reason to change this setting”. So let’s not do that.</p>
<p>Instead, we can provide the client with a copy of the server’s CA
certificate. Normally, this would come from Verisign or Thawte or
whoever you’d buy a server cert from, but since we’ve self-signed a cert
for the server, we’ve also created a cert for the CA...which is us.</p>
<p>By providing this CA cert to the client, the client will believe that
the self-signed certificate is valid, which is what we want.</p>
<p>The CA cert is a PEM file. Depending on your Linux distribution, the CA
cert file will go into <code>/etc/ssl/certs</code> (Ubuntu),
<code>/etc/openldap/cacerts</code> (Red Hat/CentOS 6), or <code>/etc/openldap/certs</code>
(Red Hat/CentOS 7). The permissions on the PEM files must be be
world-readable (644), or you must create a special group, add the owner
of the process that is accessing the cert to the group, and set the
permission of the cert file to group-readable (640).</p>
<p>There’s one more step. For whatever reason, OpenSSL expects these files
to be named in the form of HHHHHHHH.D, where each H is a hexadecimal
character and D is a single decimal digit. There’s a script in the
openssl-perl package called <code>c_rehash</code> that creates symlinks in the
right format for you. For example:</p>
<div class="highlight"><pre><span></span><span class="o">[</span><span class="n">root@host</span><span class="o">]</span><span class="err">#</span><span class="w"> </span><span class="n">c_rehash</span><span class="w"> </span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">openldap</span><span class="o">/</span><span class="n">certs</span><span class="w"></span>
<span class="n">Doing</span><span class="w"> </span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">openldap</span><span class="o">/</span><span class="n">certs</span><span class="w"></span>
<span class="k">host</span><span class="o">-</span><span class="n">ca</span><span class="p">.</span><span class="n">pem</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="mi">4</span><span class="n">d86282a</span><span class="mf">.0</span><span class="w"></span>
</pre></div>


<p>Once you have the PEM files and the symlinks in the right place, the AD
authentication in your PHP script should work.</p>
<p>Note: the c_rehash script is really doing:</p>
<div class="highlight"><pre><span></span><span class="o">[</span><span class="n">root@host</span><span class="o">]</span><span class="err">#</span><span class="w"> </span><span class="n">openssl</span><span class="w"> </span><span class="n">x509</span><span class="w"> </span><span class="o">-</span><span class="n">hash</span><span class="w"> </span><span class="o">-</span><span class="n">fingerprint</span><span class="w"> </span><span class="o">-</span><span class="n">noout</span><span class="w"> </span><span class="o">-</span><span class="ow">in</span><span class="w"> </span><span class="k">file</span><span class="p">.</span><span class="n">pem</span><span class="w"></span>
</pre></div>


<p>and taking the first line of output to create the hash file name.</p>	

	</article>



      </div>

      <div class="sidebar">
        <div class="sidebar-container" >

                <aside>
                  <h2>About</h2>
          <p>
                    This is the website of Jeremy Buchmann, a Web developer in Eindhoven, Netherlands.
          </p>
        </aside>

  	          <nav>
                <h2>Categories</h2>
                <ul>
                    <li ><a href="http://jeremybuchmann.com/category/beer.html">beer</a></li>
                    <li class="active"><a href="http://jeremybuchmann.com/category/development.html">development</a></li>
                    <li ><a href="http://jeremybuchmann.com/category/misc.html">misc</a></li>
                </ul>
              </nav>

                <aside>
                <h2>Social</h2>
          <ul class="social">
        <li><a href="https://twitter.com/jeremybuchmann">Twitter</a><i></i></li>
        <li><a href="https://www.linkedin.com/in/jeremybuchmann">LinkedIn</a><i></i></li>
        <li><a href="https://github.com/JeremyBuchmann">Github</a><i></i></li>
          </ul>
        </aside>

                <aside>
                  <h2>Foundation</h2>
                  <ul>
                      <li><a href="https://www.eindhoven.nl/">Live</a></li>
                      <li><a href="https://laurawetherington.com">Love</a></li>
                      <li><a href="https://www.coosto.com">Work</a></li>
                  </ul>
                </aside>
            </div>
      </div>

      </div>

      <footer>
    <p role="contentinfo">
      Copyright &copy; Jeremy Buchmann 2012-2018
    </p>

      </footer>

    </div>
</body>
</html>